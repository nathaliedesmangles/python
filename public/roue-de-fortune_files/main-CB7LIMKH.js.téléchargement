import{S as d,s as c,M as o,a as g,n as h,p as s,b as u,E as f}from"./logger-B0D0D8Ia.js";import{c as N,r as M}from"./create-async-iterator-BH-TlG9f.js";import{i as w,c as O}from"./install-service-worker-CMyEDn5h.js";import{runReact as S,prepareReactEnvironment as W}from"./run-react-Dgg4OQAi.js";import"./get-html-BpuETkwW.js";import"./transpile-BQ4l7_sv.js";import"./parse-transpile-error-BdCJKs_8.js";const P="/assets/python-worker-qusXoW25.js",E=new URL(P,import.meta.url);E.searchParams.set("sessionId",d);let n=null;const T=()=>{const e=new Worker(E.href,{type:"module"});return new Promise(r=>{e.onmessage=t=>{t.data.type===o.READY&&r(e)}})},y=async(e,r)=>{try{n||(n=await T())}catch(t){c.error("failed to create python worker",t)}return new Promise((t,a)=>{if(!n)return a();c.time("python.evaluation"),n.postMessage({code:e}),n.onmessage=l=>{r(l.data),l.data.type===o.RUN_COMPLETE&&(c.timeEnd("python.evaluation"),t(l.data))},n.addEventListener("terminate",()=>t(void 0))})},_=async()=>y("",()=>{}),k=()=>{try{n==null||n.dispatchEvent(new Event("terminate")),n==null||n.terminate()}finally{n=null}},i=e=>({runId:e,id:crypto.randomUUID(),timestamp:Date.now()}),I=async(e,r,t)=>{if(s({type:o.RUN_START,...i(e)}),f&&!await O())return s({...i(e),duration:null,type:o.RUN_COMPLETE}),s({runId:e,type:o.ENVIRONMENT_ERROR,error:{name:"ServiceWorker",message:"Service worker not installed"}});switch(t){case"python":return y(r,a=>{s({...a,...i(e)})});case"javascript":case"typescript":break;case"html":return M({html:r,transformPosition:null,useDocumentWrite:!0,onMessage:a=>{s({...a,...i(e)})}});case"react":for await(const a of S(r,{encodeSourceLines:!0,includeComponentImports:!0,useDocumentWrite:!0}))s({...a,...i(e)})}},C=e=>{switch(e){case"python":return _();case"react":return W();default:return null}},R=async e=>{try{switch(e.type){case u.STOP_CODE:{const{runId:r}=e;return k(),N(),s({type:o.RUN_COMPLETE,duration:null,wasCancelled:!0,...i(r)})}case u.PREPARE_ENVIRONMENT:{const{language:r}=e;return await C(r)}case u.RUN_CODE:{const{runId:r,code:t,language:a}=e;return await I(r,t,a)}}}catch(r){const t="runId"in e?e.runId:null;r instanceof Error&&s({type:o.ENVIRONMENT_ERROR,runId:t,error:{name:r.name,message:r.message}}),t&&s({type:o.RUN_COMPLETE,duration:null,...i(t)}),c.error("unexpected handleMessage error",r)}},m=[];let p=!1;const v=async e=>{if(m.push(e),!p){for(p=!0;m.length>0;){const r=m.shift();r&&await R(r)}p=!1}};w({routeName:"main",onComplete:()=>{g(e=>{e.type===u.STOP_CODE?R(e):v(e)}),h()},onError:e=>{s({type:o.ENVIRONMENT_ERROR,runId:null,error:{name:"ServiceWorker",message:"Failed to install"}})}});c.log("main.ts complete");
